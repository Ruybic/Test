<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osu! Iraq Today | Rankings</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --osu-pink: #ff66aa; 
            --dark-base: #1c1c21; 
            --panel-bg: #2e2e38; 
            --text-main: #ffffff; 
            --text-muted: #888895;
            --accent-gold: #ffd700;
            --accent-blue: #22ccff;
        }
        
        body { background-color: var(--dark-base); color: var(--text-main); font-family: 'Exo 2', sans-serif; margin: 0; line-height: 1.6; }

        /* HEADER */
        header {
            background: #111116; padding: 12px 25px; display: flex; align-items: center;
            justify-content: space-between; border-bottom: 2px solid var(--panel-bg);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo-box a { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo-box img { height: 38px; display: block; }
        .logo-text { color: var(--osu-pink); font-weight: 800; font-size: 18px; letter-spacing: 0.5px; }

        /* NAV DROPDOWN */
        .dropdown { position: relative; }
        .dropbtn { background: var(--panel-bg); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-family: 'Exo 2'; font-weight: 600; transition: 0.2s; }
        .dropbtn:hover { background: #3e3e4a; }
        .dropdown-content {
            display: none; position: absolute; right: 0; background-color: #25252e;
            min-width: 180px; box-shadow: 0px 8px 24px rgba(0,0,0,0.6); z-index: 1; border-radius: 6px; margin-top: 8px; overflow: hidden;
        }
        .dropdown-content a { color: white; padding: 14px 20px; text-decoration: none; display: block; font-size: 14px; border-bottom: 1px solid #333; }
        .dropdown-content a:hover { background: #3e3e4a; color: var(--osu-pink); }
        .show { display: block; }

        /* CONTROLS AREA */
        .controls-container { max-width: 1100px; margin: 30px auto 15px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .sort-select { 
            background: var(--panel-bg); color: white; border: 1px solid #3e3e4a; padding: 10px 15px; 
            border-radius: 8px; font-family: 'Exo 2'; font-weight: 600; outline: none; cursor: pointer; transition: 0.2s;
        }
        .sort-select:focus { border-color: var(--osu-pink); }

        /* LEADERBOARD LIST */
        .leaderboard-list { max-width: 1100px; margin: 0 auto; padding: 0 20px 60px; display: flex; flex-direction: column; gap: 12px; }
        
        .player-card { 
            background: var(--panel-bg); border-radius: 12px; padding: 15px; border: 1px solid #3e3e4a; 
            display: flex; flex-direction: column; gap: 10px; transition: 0.2s; 
        }
        .player-card:hover { border-color: var(--osu-pink); transform: translateX(5px); background: #343440; }

        .player-main { display: flex; justify-content: space-between; align-items: center; }
        .player-identity { display: flex; align-items: center; gap: 15px; }
        .rank-badge { font-size: 20px; font-weight: 900; color: var(--text-muted); width: 45px; text-align: center; }
        .avatar { width: 52px; height: 52px; border-radius: 10px; border: 2px solid #1c1c21; }
        .user-link { font-size: 18px; font-weight: 800; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .user-link:hover { color: var(--osu-pink); }
        .flag { width: 22px; border-radius: 3px; }

        .stat-block { text-align: right; }
        .stat-value { font-size: 22px; font-weight: 900; color: var(--osu-pink); line-height: 1; }
        .activity-indicator { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; color: var(--text-muted); justify-content: flex-end; margin-top: 6px; }
        .dot { width: 9px; height: 9px; border-radius: 50%; }
        .dot.online { background-color: #88ffcc; box-shadow: 0 0 10px #88ffcc; }
        .dot.offline { background-color: #ff4444; }

        /* TOP PLAY BANNER */
        .top-play-banner {
            position: relative; border-radius: 8px; height: 50px; overflow: hidden;
            display: flex; align-items: center; padding: 0 20px; text-decoration: none;
            background-size: cover; background-position: center; border: 1px solid #1c1c21;
        }
        .top-play-banner::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, rgba(15,15,20,0.95) 0%, rgba(15,15,20,0.7) 60%, rgba(15,15,20,0.2) 100%);
        }
        .tp-content { position: relative; z-index: 2; width: 100%; display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 600; color: #eee; }
        .tp-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
        .tp-title strong { color: var(--accent-gold); }
        .tp-stats { font-weight: 800; color: var(--text-main); }
        .tp-acc { color: #88ffcc; margin-right: 8px; }

        /* LOADER */
        .loader { text-align: center; padding: 100px; color: var(--text-muted); font-weight: 800; letter-spacing: 2px; }
    </style>
</head>
<body>

<header>
    <div class="logo-box">
        <a href="index.html">
            <img src="https://i.imgur.com/1YJfjH6.png" alt="osu! Iraq">
            <span class="logo-text">Osu! Iraq Today</span>
        </a>
    </div>
    <div class="dropdown">
        <button class="dropbtn" id="menuBtn">Rankings ▼</button>
        <div class="dropdown-content" id="myDropdown">
            <a href="index.html">Daily Scores</a>
            <a href="community.html">Community</a>
            <a href="videos.html">Videos</a>
            <a href="mapping.html">Mapping</a>
        </div>
    </div>
</header>

<div class="controls-container">
    <h2 style="margin:0; font-size: 14px; color: var(--text-muted); letter-spacing: 1px;">TOP 500 PLAYERS</h2>
    <select id="sortSelect" class="sort-select">
        <option value="pp">Rank by PP (Default)</option>
        <option value="daily_pp">Most PP Gained Today</option>
        <option value="last_active">Recently Active</option>
        <option value="ss_count">Total SS Count</option>
        <option value="s_count">Total S Count</option>
        <option value="medals">Medal Count</option>
        <option value="accuracy">Global Accuracy</option>
        <option value="play_time">Play Time</option>
        <option value="play_count">Play Count</option>
        <option value="total_score">Total Score</option>
    </select>
</div>

<div class="leaderboard-list" id="leaderboardGrid">
    <div class="loader">FETCHING PLAYER DATA...</div>
</div>

<script>
// --- NAVIGATION LOGIC ---
const menuBtn = document.getElementById('menuBtn');
const dropdown = document.getElementById('myDropdown');

menuBtn.onclick = (e) => { 
    dropdown.classList.toggle("show"); 
    e.stopPropagation(); 
};

window.onclick = (e) => { 
    if (!e.target.matches('.dropbtn')) {
        dropdown.classList.remove('show');
    }
};

// --- DATA LOGIC ---
let currentData = [];

const fmtNum = (n) => Number(n).toLocaleString();
const fmtTime = (s) => (s / 3600).toFixed(0) + 'h';

async function fetchRankings() {
    const grid = document.getElementById('leaderboardGrid');
    
    try {
        // 1. Get the index.
        const indexRes = await fetch('data/leaderboards/index.json?t=' + Date.now());
        if (!indexRes.ok) throw new Error("Index not found");
        
        const index = await indexRes.json();
        const latestDate = index.available_dates[index.available_dates.length - 1];
        
        // 2. Parse Date. Based on your repo, folders use padding (e.g., /02/22.json)
        const parts = latestDate.split('-');
        const y = parts[0];
        const m = parts[1].padStart(2, '0');
        const d = parts[2].padStart(2, '0');
        
        // 3. Construct path matching your repo structure
        const finalPath = `data/leaderboards/${y}/${m}/${d}.json?t=${Date.now()}`;
        console.log("Fetching data from:", finalPath);

        const dataRes = await fetch(finalPath);
        if (!dataRes.ok) throw new Error(`Data missing at ${finalPath}`);

        currentData = await dataRes.json();
        renderList('pp'); 
        
    } catch (e) {
        console.error("Fetch Error:", e);
        grid.innerHTML = `<div class="loader" style="color:#ff66aa">ERROR: ${e.message}</div>`;
    }
}

function renderList(sortBy) {
    const grid = document.getElementById('leaderboardGrid');
    grid.innerHTML = '';

    let sorted = [...currentData];
    sorted.sort((a, b) => {
        if (sortBy === 'last_active') return new Date(b.last_active) - new Date(a.last_active);
        // Standard descending sort for numbers
        return (b[sortBy] || 0) - (a[sortBy] || 0);
    });

    sorted.forEach((player, index) => {
        let primaryStatHtml = `${fmtNum(Math.round(player.pp))}pp`;
        
        // Contextual labeling based on sorting
        if (sortBy === 'daily_pp') primaryStatHtml = `<span style="color:#88ffcc">+${Math.round(player.daily_pp)}pp</span> Today`;
        else if (sortBy === 'ss_count') primaryStatHtml = `${fmtNum(player.ss_count)} <span style="color:#f0f; font-size:14px;">SS</span>`;
        else if (sortBy === 's_count') primaryStatHtml = `${fmtNum(player.s_count)} <span style="color:var(--accent-gold); font-size:14px;">S</span>`;
        else if (sortBy === 'medals') primaryStatHtml = `${player.medals} Medals`;
        else if (sortBy === 'accuracy') primaryStatHtml = `${(player.accuracy * 100).toFixed(2)}%`;
        else if (sortBy === 'play_time') primaryStatHtml = `${fmtTime(player.play_time)} Played`;
        else if (sortBy === 'total_score') primaryStatHtml = `${(player.total_score / 1000000000).toFixed(1)}B Score`;

        const diffDays = (Date.now() - new Date(player.last_active)) / (1000 * 3600 * 24);
        const isActive = diffDays < 3;
        const dotClass = isActive ? 'online' : 'offline';

        let topPlayHtml = '';
        if (player.top_play) {
            const tp = player.top_play;
            topPlayHtml = `
                <a href="https://osu.ppy.sh/users/${player.id}" target="_blank" class="top-play-banner" style="background-image: url('${tp.cover}');">
                    <div class="tp-content">
                        <div class="tp-title">
                            <span class="tp-acc">${tp.acc.toFixed(2)}%</span>
                            ${tp.title} [${tp.diff}] <strong>${tp.mods}</strong>
                        </div>
                        <div class="tp-stats">
                            ${tp.stars.toFixed(2)}⭐ | ${Math.round(tp.pp)}PP
                        </div>
                    </div>
                </a>
            `;
        }

        const card = document.createElement('div');
        card.className = 'player-card';
        card.innerHTML = `
            <div class="player-main">
                <div class="player-identity">
                    <div class="rank-badge">#${index + 1}</div>
                    <img src="${player.avatar}" class="avatar" loading="lazy">
                    <div>
                        <a href="https://osu.ppy.sh/users/${player.id}" target="_blank" class="user-link">
                            <img src="https://osu.ppy.sh/images/flags/IQ.png" class="flag"> ${player.user}
                        </a>
                    </div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${primaryStatHtml}</div>
                    <div class="activity-indicator">
                        ${isActive ? 'Active' : 'Inactive'} <div class="dot ${dotClass}"></div>
                    </div>
                </div>
            </div>
            ${topPlayHtml}
        `;
        grid.appendChild(card);
    });
}

document.getElementById('sortSelect').onchange = (e) => renderList(e.target.value);

fetchRankings();
</script>
</body>
</html>
